'''
Extracting main header information from VLTI instruments
'''
import numpy as np 
from astropy.io import fits

def extract_header_info(filename):
    '''
    extract_header_info

    Extracts from a gravity oifits file the qc header parameters 

    :param filename: oifits file
    :type filename: string
    :return: Dictionary of qc parameters values
    :rtype: Dictionary
    '''
    hdu = fits.open(filename)
    keylist = list(hdu[0].header.keys())
    headerdir = {}
    # extraction of qc and + parameters
    for key in keylist:
        if (key[0:6] == "ESO QC"):
            headerdir[key[7:]] = hdu[0].header[key]
        if (key[0:7] == "ESO ISS"):
            headerdir[key[8:]] = hdu[0].header[key]
        if (key[0:6]) == "ESO FT":
            headerdir[key[4:]] = hdu[0].header[key]
        # extracting mjd
        mjd = hdu[0].header['MJD-OBS']
        headerdir['MJD'] = mjd
        date = hdu[0].header['DATE'][0:10]
        headerdir['DATE'] = date 
        # extracting (if present) the weather information
        try:
            fwhme= hdu[0].header['HIERARCH ESO ISS AMBI FWHM END']
            fwhms= hdu[0].header['HIERARCH ESO ISS AMBI FWHM START']
            seeing = (fwhme + fwhms) / 2
            tau0e= hdu[0].header['HIERARCH ESO ISS AMBI TAU0 END']
            tau0s= hdu[0].header['HIERARCH ESO ISS AMBI TAU0 START']
            tau0 = (tau0s + tau0e) / 2
            windspeed = hdu[0].header['HIERARCH ESO ISS AMBI WINDSP']
        except:
            #print("No ESO ISS AMBI information")
            seeing = tau0 = windspeed = 0.0
        headerdir['FWHM'] = seeing
        headerdir['TAU0'] = tau0
        headerdir['WINDSP'] = windspeed
        headerdir['INSTRUMENT'] = hdu[0].header['INSTRUME']
        headerdir['GUID MAG'] = hdu[0].header['HIERARCH ESO COU GUID MAG'] # star SCI magnitude
        headerdir['SCI MAG'] = hdu[0].header['HIERARCH ESO INS SOBJ MAG'] # coude guiding magnitude                       
        try:
            headerdir['TARGET'] = hdu[0].header['HIERARCH ESO OBS TARG NAME']
        except:
            headerdir['TARGET'] = "Not Found"
        headerdir['FILE'] = filename

    return headerdir
    



